library(geepack)
library(statmod)
library(splines)
library(SimDesign)
library(gridExtra)
library(ggplot2)
library(car)
library(pracma)
library(stringr)
library(mgcv)
library(lubridate)
library(forecast)

inDir = 'I:/TimeSeries'
seasDir = 'I:/Seasonal_Plots'
int = "Daily"

fileList = list.files(path=inDir,pattern=paste('*_',int,'.csv',sep=""),
                      full.names=TRUE,recursive=FALSE,
                      include.dirs=FALSE,no..=TRUE)


for (i in 1:numel(fileList)){  # for each species' file

  thisCT = data.frame(read.csv(fileList[i]))  # load file
  attribs = attributes(thisCT)  # find names of sites (all columns but first)
  sites = attribs$names[2:numel(attribs$names)]
  
  CTname = str_remove(fileList[i],paste(inDir,'/',sep="")) # get the species/CT name
  CTname = str_remove(CTname,paste('_',int,'.csv',sep=""))
  
  #dateVec = as.POSIXlt(thisCT$Date,tz="GMT",format="%d-%b-%Y")
  dateVec = as.Date(thisCT$Date,format="%d-%b-%Y")
  
  
  # if it doesn't already exist, create directory to save figures
  if (!dir.exists(paste(seasDir,'/',CTname,sep=""))){
    dir.create(paste(seasDir,'/',CTname,sep=""))
  }
  
  for (j in 1:numel(sites)){ # for each site
    
    thisSite = as.numeric(thisCT[,j+1]) # get presence data for this site
    pres = which(thisSite!=0)
    
    if (!numel(pres)==0){ # if there is any presence
      
      plot(dateVec,thisCT[,j+1],main=paste(CTname,'at',sites[j],sep=" "),
           ylab="# 5-min Bins w Presence")
      userVote = readline(promtp="Enter 1 to proceed with modeling, or 0 to skip to next deployment:")
      
      
      if (as.numeric(userVote)==1){
        
        corr = acf(thisSite,lag.max=100,na.action=na.pass,plot=FALSE) 
        lagID = which(abs(corr$acf)<0.1) # determine lag at which autocorrelation is <0.15
        #itsVal = IntegralTimeScaleCalc(thisSite)
        numClust = length(thisSite)/(lagID[1]-1)
        clustID = rep(1:ceiling(numClust),each=lagID[1]) # create grouping vector for GEEGLM
        clustID = clustID[1:numel(thisSite)]
        
        noDat = which(is.na(thisSite)) # remove days with no presence data
        thisSite = thisSite[-noDat]
        thisSite = round(thisSite)
        reducedDateVec = dateVec[-noDat]
        reducedClustID = clustID[-noDat]
        #Jday = reducedDateVec$yday
        Jday = as.numeric(format(reducedDateVec,"%j"))
        monthGroup = month(reducedDateVec) # find which month each day of data falls in
        yearGroup = year(reducedDateVec) # find which year each day of data falls in
        
        # account for leap day in 2016, shift Julian days by value of 1
        leapIdx = which(yearGroup==2016)
        Jday[leapIdx] = Jday[leapIdx]-1
        
        
        
        # Fit GAM
        JDayGAM = gam(thisSite~s(Jday,bs="cc")+as.factor(yearGroup),
                      family=tw)
        sinkName = paste(seasDir,'/',CTname,'/',sites[j],"_GAMSummary.txt",sep="")
        sink(sinkName)
        print(summary(JDayGAM))
        sink()
        
        # Plot partial residuals
        saveName = paste(seasDir,'/',CTname,'/',sites[j],"_GAM.png",sep="")
        png(saveName,width=600,height=300)
        plot.gam(JDayGAM,all.terms=TRUE,pages=1,main=paste(CTname,'at',sites[j]))
        dev.off()
        
        
        # Fit GEEGLM
        
        # modJday = geeglm(thisSite~cSplineDes(Jday,seq(1,365,length.out=5))+
        #                  as.factor(yearGroup),
        #                family=poisson(link="log"),
        #                id=reducedClustID,
        #                corstr="ar1")
        modJday = geeglm(thisSite~bs(Jday,knots=mean(Jday))+as.factor(yearGroup),
                         family=poisson(link="log"),
                         id=reducedClustID,
                         corstr="ar1")
        sinkName = paste(seasDir,'/',CTname,'/',sites[j],"_GEEGLMSummary.txt",sep="")
        sink(sinkName)
        print(summary(modJday))
        sink()
        
        # modMon = geeglm(thisSite~bs(monthGroup,knots=mean(monthGroup))+as.factor(yearGroup),
        #                  family=poisson(link="log"),
        #                  id=reducedClustID,
        #                  corstr="ar1")
        # summary(modMon)
        
        
        # Bootstrap parameter estimate confidence intervals
        JDayForPlotting<- seq(min(Jday), max(Jday), length=50)
        JDayBootstrapParameters<-rmvnorm(10000, coef(modJday), summary(modJday)$cov.unscaled)
        testJday<- glm(thisSite ~ bs(Jday,knots=mean(Jday))+
                         as.factor(yearGroup),
                       family=poisson)
        Jx1<-model.matrix(testJday)[,2:5]%*%coef(modJday)[c(2:5)]
        Jx2<-model.matrix(testJday)[,c(1,6:8)]%*%coef(modJday)[c(1,6:8)]
        
        
        # MonthForPlotting<- seq(min(monthGroup), max(monthGroup), length=50)
        # MonBootstrapParameters<-rmvnorm(10000, coef(modMon), summary(modMon)$cov.unscaled)
        # testMon<- glm(thisSite ~ bs(monthGroup,knots=mean(monthGroup))+
        #                  as.factor(yearGroup),
        #                family=poisson)
        # Mx1<-model.matrix(testMon)[,2:5]%*%coef(modMon)[c(2:5)]
        # Mx2<-model.matrix(testMon)[,c(1,6:8)]%*%coef(modMon)[c(1,6:8)]
        
        YearBootstrapCoefs<- JDayBootstrapParameters[,c(1,6:8)]
        quant.func<- function(x){quantile(x, probs=c(0.025,0.975))}
        cisY<-apply(YearBootstrapCoefs, 2, quant.func)
        # cilY<-cis[1,]-mean(Jx2)-coef(modJday)[1]
        # ciuY<-cis[2,]-mean(Jx2)-coef(modJday)[1]
        
        
        # Plot partial residuals
        # Julian Day
        JDayBootstrapCoefs<- JDayBootstrapParameters[,2:5]
        Basis<- bs(JDayForPlotting, knots=mean(Jday), Boundary.knots=range(Jday))
        RealFit<- Basis%*%coef(modJday)[c(2:5)]
        RealFitCenterJ<- RealFit-mean(Jx1)-coef(modJday)[1]
        JDayBootstrapFits<- Basis%*%t(JDayBootstrapCoefs)
        quant.func<- function(x){quantile(x, probs=c(0.025,0.975))}
        cis<-apply(JDayBootstrapFits, 1, quant.func)
        MinimumYlimJ<- min(cis-mean(Jx1)-coef(modJday)[1])
        MaximumYlimJ<- max(cis-mean(Jx1)-coef(modJday)[1])
        Jcil<-cis[1,]-mean(Jx1)-coef(modJday)[1]
        Jciu<-cis[2,]-mean(Jx1)-coef(modJday)[1]
        saveName = paste(seasDir,'/',CTname,'/',sites[j],"_GEEGLM_JDayPlot.png",sep="")
        png(saveName,width=700,height=400)
        qplot(JDayForPlotting,RealFitCenterJ,xlab="Julian Day", ylab="s(Julian Day)", 
              ylim=c(MinimumYlimJ, MaximumYlimJ),
              geom="line")+theme(axis.line = element_line(),
                                 panel.background=element_blank(),
                                 panel.grid.major=element_blank(),
                                 panel.grid.minor=element_blank())+geom_smooth(fill="grey",
                                                                               colour="black",
                                                                               aes(ymin=Jcil,ymax=Jciu),
                                                                               stat="identity")+geom_rug(aes(x = Jday, y=-10000))
        dev.off()
        
        # Month
        # MonBootstrapCoefs<- MonBootstrapParameters[,2:5]
        # Basis<- bs(MonthForPlotting, knots=mean(monthGroup), Boundary.knots=range(monthGroup))
        # RealFit<- Basis%*%coef(modMon)[c(2:5)]
        # RealFitCenterM<- RealFit-mean(Mx1)-coef(modMon)[1]
        # MonBootstrapFits<- Basis%*%t(MonBootstrapCoefs)
        # quant.func<- function(x){quantile(x, probs=c(0.025,0.975))}
        # cis<-apply(MonBootstrapFits, 1, quant.func)
        # MinimumYlimM<- min(cis-mean(Mx1)-coef(modMon)[1])
        # MaximumYlimM<- max(cis-mean(Mx1)-coef(modMon)[1])
        # Mcil<-cis[1,]-mean(Mx1)-coef(modMon)[1]
        # Mciu<-cis[2,]-mean(Mx1)-coef(modMon)[1]
        # plot2<-qplot(MonthForPlotting,RealFitCenterM,
        #              xlab="Month", ylab="s(Month)", 
        #              main="b",ylim=c(MinimumYlimM, MaximumYlimM),
        #              geom="line")+theme(axis.line = element_line(),
        #                                 panel.background=element_blank(),
        #                                 panel.grid.major=element_blank(),
        #                                 panel.grid.minor=element_blank())+geom_smooth(fill="grey",
        #                                                                               colour="black",
        #                                                                               aes(ymin=Mcil,ymax=Mciu),
        #                                                                               stat="identity")+geom_rug(aes(x = monthGroup, y=-10000))
        
        # Year
        # years = as.numeric(2016:2019)
        # yearCoefs = as.numeric(apply(YearBootstrapCoefs,2,mean))
        # plot(years,yearCoefs,type="p",pch=21,cex=1.5,col="black",bg="black")
        # 
        # yearDat = data.frame(as.factor(years),yearCoefs,cil=cisY[1,],ciu=cisY[2,])
        # j = ggplot(yearDat,aes(x=years,y=yearCoefs,ymin=cil,ymax=ciu))
        # j + geom_linerange(data.frame(modJday$coefficients[c(1,6:8)]),
        #                    ymin=cis[1,],ymax=cis[2,])
        
        AdjustedYearCoefs = data.frame(YearBootstrapCoefs[,1],
                                       YearBootstrapCoefs[,2]+mean(YearBootstrapCoefs[,1]),
                                       YearBootstrapCoefs[,3]+mean(YearBootstrapCoefs[,1]),
                                       YearBootstrapCoefs[,4]+mean(YearBootstrapCoefs[,1]))
        colnames(AdjustedYearCoefs) = c("2016","2017","2018","2019")
        AdjustedYearCoefs = apply(AdjustedYearCoefs,2,exp)
        
        
        saveName = paste(seasDir,'/',CTname,'/',sites[j],"_GEEGLM_YearPlot.png",sep="")
        png(saveName,width=500,height=400)
        boxplot(AdjustedYearCoefs,main=paste(CTname,'at',sites[j]),
                ylab=c("Daily Counts"),ylim=range(0:max(AdjustedYearCoefs)*1.2))
        #grid.arrange(plot1,plot2,ncol=1,nrow=2)
        dev.off()
      }
    
    }

  }
}
